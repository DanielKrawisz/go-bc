package bc

import (
	"context"
	"errors"
	"testing"

	"github.com/stretchr/testify/assert"
)

type mockBlockHeaderClient struct {
	blockHeaderFunc func(context.Context, string) (*BlockHeader, error)
}

func (m *mockBlockHeaderClient) BlockHeader(ctx context.Context, blockHash string) (*BlockHeader, error) {
	if m.blockHeaderFunc != nil {
		return m.blockHeaderFunc(ctx, blockHash)
	}

	return nil, errors.New("blockHeaderFunc in test is undefined")
}

func TestSPVEnvelope_VerifyPayment(t *testing.T) {
	tests := map[string]struct {
		envelope        *SPVEnvelope
		blockHeaderFunc func(context.Context, string) (*BlockHeader, error)
		exp             bool
		expErr          error
	}{
		"valid envelope passes": {
			exp: true,
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020d9c6bb358e13ec549c3e78ad67b2975f72e164d44f925ccf36fdaf3a35959b0348f38f71db7afaecc2b8b324c44ec05eed43a98de16fcb2e7e501622abff759cb2210161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd",
							Target: "7264e88cccd8f3cbfc37f3a237b74ed02612c2f381291e3ffc1c70978642afd0",
							Nodes: []string{
								"b1f3ed9a26f39f910a5186f4d33cc5fcef7fdc71328e96f3324e9eb84b54476e",
								"e2a39c08e6cb998a5c7b5e9f4ac9303af43d8e6a859ad8127d9e2c569324f7d2",
								"b17da0617adee7a7dad8147ca03cf5541c33ba10918dd88ddb2bc3889d78db05",
							},
						},
					},
				},
			},
		},
		"envelop without any proof fails": {
			exp:    false,
			expErr: errors.New("no confirmed transaction provided"),
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020d9c6bb358e13ec549c3e78ad67b2975f72e164d44f925ccf36fdaf3a35959b0348f38f71db7afaecc2b8b324c44ec05eed43a98de16fcb2e7e501622abff759cb2210161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
					},
				},
			},
		},
		"valid envelope with merkle proof supplied as hex passes": {
			exp: true,
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020d9c6bb358e13ec549c3e78ad67b2975f72e164d44f925ccf36fdaf3a35959b0348f38f71db7afaecc2b8b324c44ec05eed43a98de16fcb2e7e501622abff759cb2210161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
							Target: "7264e88cccd8f3cbfc37f3a237b74ed02612c2f381291e3ffc1c70978642afd0",
							Nodes: []string{
								"b1f3ed9a26f39f910a5186f4d33cc5fcef7fdc71328e96f3324e9eb84b54476e",
								"e2a39c08e6cb998a5c7b5e9f4ac9303af43d8e6a859ad8127d9e2c569324f7d2",
								"b17da0617adee7a7dad8147ca03cf5541c33ba10918dd88ddb2bc3889d78db05",
							},
						},
					},
				},
			},
		},
		"invalid merkle proof fails": {
			exp: false,
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020d9c6bb358e13ec549c3e78ad67b2975f72e164d44f925ccf36fdaf3a35959b0348f38f71db7afaecc2b8b324c44ec05eed43a98de16fcb2e7e501622abff759cb2210161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{
							Index:  3, // failing part, would pass if index were 1
							TxOrID: "61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd",
							Target: "7264e88cccd8f3cbfc37f3a237b74ed02612c2f381291e3ffc1c70978642afd0",
							Nodes: []string{
								"b1f3ed9a26f39f910a5186f4d33cc5fcef7fdc71328e96f3324e9eb84b54476e",
								"e2a39c08e6cb998a5c7b5e9f4ac9303af43d8e6a859ad8127d9e2c569324f7d2",
								"b17da0617adee7a7dad8147ca03cf5541c33ba10918dd88ddb2bc3889d78db05",
							},
						},
					},
				},
			},
		},
		"tx relying on multiple proofs passes": {
			exp: true,
			blockHeaderFunc: func(ctx context.Context, blockhash string) (*BlockHeader, error) {
				if blockhash == "4d24ca92094980f0daacd7639f9329cf35848240db84fdd4c72b604082609bde" {
					return EncodeBlockHeaderStr("000000200adb899e30726063e84b74d439b67309497c4717825a6ba6aa575fe349750561d5b08c94d2beae4847cec09da1aea32cfd5e0f11add310eb7c6d1b427fbc09c647320161ffff7f2000000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "e3c66e4eddaa7e7e7560cdd8a80c82126dcbb728b4a3bf48a2be95a7847feacc",
				RawTX: "02000000043324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c000000006b483045022100a1e96789f10de15167385eb1f7505628755aa43750ed0df998066d1b6526a5fe02205883662a7c231509ab233026a9bd7dac1221fcfd22cf92c543ce761588ead52b4121029312d305d805dcbf68a0ffaee417a4852d86ce38708725feff2b1a85db53cc59feffffff0f316367b51170c4c80a4285a3f47712efc4b47b56e736a284aa38bd0e1ec9d4000000006a47304402205d7100dd0bcc901507e84cd94e88da90973fd8381eeec24bdc84e70519604b0c02207bb9eacd817eb04378655a32807f3e76d5ed65cff147fac659db270699b44ef5412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505000000006a4730440220255e048d53f6e3897ea1adebe3ce09259ec8f4814939091a0ff93d754c2f508d02201cbda92db5f25b62363dbf744e6a4b82ec3eb9a9a075d08d8051c9729021d69f4121033e792b95ce7a8c70f68ae6070d5b545957343919fab8b0cb4d6915b6117477d3fefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505010000006b483045022100ff091628f91fbb9ceda9cd62747e570508f95d14205211288071bd3ae4a4500c0220080dba7b1b9379b21c1bd5fed22f582094b54fdb29c16cfe4de3f709d12975e4412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffeffffff029ee8fa02000000001976a9146922fe7841288aa0d71292cb8325c4205e4674d288ac8055c820000000001976a914e4e6936b51ecbe715846556b083747bae09e769088ac6b000000",
				Inputs: map[string]*SPVEnvelope{
					"1cd17879b7a8a604cd10fe34a1872fec2b2bf0e4d0612445daa5a20737272433": {
						RawTX: "02000000020e088697d6908275ab3084f77ca45d523433a3352947d1c1599a1a9fc9bb47a7000000006b48304502210096373becf407ec50251aac835a9902173707688fa6dab001de9abe6acea3f98a022040f5b15ecf2e11d106878777e470e144bdb96fc567233eeb966989c958d16719412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffeffffff0e088697d6908275ab3084f77ca45d523433a3352947d1c1599a1a9fc9bb47a7010000006b483045022100e0d75f4cc3d8b60ef36caa9d099975c3f3201a2e48ad1f8ac0d74d8e07a0aee40220459619b284589b53f14514b3c203b31a40d1442159c64d8e8631a68f9f74f5f841210302b1d9199e7a9357a24c98d5c22822fbaf4a1f39838bc564bd9b4384a75615a6feffffff021ecdf008000000001976a914ac0c1480344ba91deb47415153dbf7d2e4b1ccf788ac80b2e60e000000001976a914e4e6936b51ecbe715846556b083747bae09e769088ac69000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "1cd17879b7a8a604cd10fe34a1872fec2b2bf0e4d0612445daa5a20737272433",
							Target: "4d24ca92094980f0daacd7639f9329cf35848240db84fdd4c72b604082609bde",
							Nodes: []string{
								"82e2faf3f1966eefbea0a88e77c629dfc35320e77ee053ee2071adf341cecda8",
							},
						},
					},
					"d4c91e0ebd38aa84a236e7567bb4c4ef1277f4a385420ac8c47011b56763310f": {
						RawTX: "0200000001be304e579f89ea351c9eb351d8e29b72fb6ad71704553134e67a526b423490da010000006a47304402204b035ef4e8190ddbf6a11343ef46cdf6a35b60d18b3aec169c90463b52ab60c602205dc830ab4806c37f9875c234a8389a99f7a8b7a3b5e6cbd1e557dcf5e12df0f3412102129cf1690078801a48c1fe3c0bdb6d8aac90756633c9fb7bec40f28403f7a3d9feffffff0200c2eb0b000000001976a914cf3904101bdf618e8f0446bfab91c345111908a088ac1ea2e111000000001976a914ba4276fe9cca9c4d0e5bbefa6b5b7ee74a36fa6c88ac6a000000",
						Proof: &MerkleProof{
							Index:  2,
							TxOrID: "d4c91e0ebd38aa84a236e7567bb4c4ef1277f4a385420ac8c47011b56763310f",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"025a356701f41c40769558a8962c765cb6b1da2bb3f7007916ad3c187215736c",
								"fe4c0107b918c1366dc0485c404e7b6f92eb9499fd0036a07f9e58d3b4a992e8",
							},
						},
					},
					"05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa": {
						RawTX: "02000000013324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c010000006b483045022100bde190f6a794aaaf14b4f1c553724883c8732c6bdcaae8b1633d52df769ffa1f02207f7cfed7183fd8515a575b070297e86a49c548977e456848f3109f342fc754ae412102129cf1690078801a48c1fe3c0bdb6d8aac90756633c9fb7bec40f28403f7a3d9feffffff029eeffa02000000001976a914972e260dd73b41f8d91b1709005b60355cdc36ed88ac00c2eb0b000000001976a914cf3904101bdf618e8f0446bfab91c345111908a088ac6a000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"1c84115865bf49ab2eadf27548cdcb3c36cb8ca5402d77ffa90f1de001a3fee3",
								"98979feadc42e66a67d762f930c22bf12d04ff8224b9d9b859ab29980a27f90a",
							},
						},
					},
				},
			},
		},
		"tx relying on multiple proofs with one false fails": {
			exp: false,
			blockHeaderFunc: func(ctx context.Context, blockhash string) (*BlockHeader, error) {
				if blockhash == "4d24ca92094980f0daacd7639f9329cf35848240db84fdd4c72b604082609bde" {
					return EncodeBlockHeaderStr("000000200adb899e30726063e84b74d439b67309497c4717825a6ba6aa575fe349750561d5b08c94d2beae4847cec09da1aea32cfd5e0f11add310eb7c6d1b427fbc09c647320161ffff7f2000000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "e3c66e4eddaa7e7e7560cdd8a80c82126dcbb728b4a3bf48a2be95a7847feacc",
				RawTX: "02000000043324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c000000006b483045022100a1e96789f10de15167385eb1f7505628755aa43750ed0df998066d1b6526a5fe02205883662a7c231509ab233026a9bd7dac1221fcfd22cf92c543ce761588ead52b4121029312d305d805dcbf68a0ffaee417a4852d86ce38708725feff2b1a85db53cc59feffffff0f316367b51170c4c80a4285a3f47712efc4b47b56e736a284aa38bd0e1ec9d4000000006a47304402205d7100dd0bcc901507e84cd94e88da90973fd8381eeec24bdc84e70519604b0c02207bb9eacd817eb04378655a32807f3e76d5ed65cff147fac659db270699b44ef5412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505000000006a4730440220255e048d53f6e3897ea1adebe3ce09259ec8f4814939091a0ff93d754c2f508d02201cbda92db5f25b62363dbf744e6a4b82ec3eb9a9a075d08d8051c9729021d69f4121033e792b95ce7a8c70f68ae6070d5b545957343919fab8b0cb4d6915b6117477d3fefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505010000006b483045022100ff091628f91fbb9ceda9cd62747e570508f95d14205211288071bd3ae4a4500c0220080dba7b1b9379b21c1bd5fed22f582094b54fdb29c16cfe4de3f709d12975e4412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffeffffff029ee8fa02000000001976a9146922fe7841288aa0d71292cb8325c4205e4674d288ac8055c820000000001976a914e4e6936b51ecbe715846556b083747bae09e769088ac6b000000",
				Inputs: map[string]*SPVEnvelope{
					"1cd17879b7a8a604cd10fe34a1872fec2b2bf0e4d0612445daa5a20737272433": {
						RawTX: "02000000020e088697d6908275ab3084f77ca45d523433a3352947d1c1599a1a9fc9bb47a7000000006b48304502210096373becf407ec50251aac835a9902173707688fa6dab001de9abe6acea3f98a022040f5b15ecf2e11d106878777e470e144bdb96fc567233eeb966989c958d16719412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffeffffff0e088697d6908275ab3084f77ca45d523433a3352947d1c1599a1a9fc9bb47a7010000006b483045022100e0d75f4cc3d8b60ef36caa9d099975c3f3201a2e48ad1f8ac0d74d8e07a0aee40220459619b284589b53f14514b3c203b31a40d1442159c64d8e8631a68f9f74f5f841210302b1d9199e7a9357a24c98d5c22822fbaf4a1f39838bc564bd9b4384a75615a6feffffff021ecdf008000000001976a914ac0c1480344ba91deb47415153dbf7d2e4b1ccf788ac80b2e60e000000001976a914e4e6936b51ecbe715846556b083747bae09e769088ac69000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "1cd17879b7a8a604cd10fe34a1872fec2b2bf0e4d0612445daa5a20737272433",
							Target: "4d24ca92094980f0daacd7639f9329cf35848240db84fdd4c72b604082609bde",
							Nodes: []string{
								"82e2faf3f1966eefbea0a88e77c629dfc35320e77ee053ee2071adf341cecda8",
							},
						},
					},
					"d4c91e0ebd38aa84a236e7567bb4c4ef1277f4a385420ac8c47011b56763310f": {
						RawTX: "0200000001be304e579f89ea351c9eb351d8e29b72fb6ad71704553134e67a526b423490da010000006a47304402204b035ef4e8190ddbf6a11343ef46cdf6a35b60d18b3aec169c90463b52ab60c602205dc830ab4806c37f9875c234a8389a99f7a8b7a3b5e6cbd1e557dcf5e12df0f3412102129cf1690078801a48c1fe3c0bdb6d8aac90756633c9fb7bec40f28403f7a3d9feffffff0200c2eb0b000000001976a914cf3904101bdf618e8f0446bfab91c345111908a088ac1ea2e111000000001976a914ba4276fe9cca9c4d0e5bbefa6b5b7ee74a36fa6c88ac6a000000",
						Proof: &MerkleProof{
							Index:  1, // failing part, would pass if index were 2
							TxOrID: "d4c91e0ebd38aa84a236e7567bb4c4ef1277f4a385420ac8c47011b56763310f",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"025a356701f41c40769558a8962c765cb6b1da2bb3f7007916ad3c187215736c",
								"fe4c0107b918c1366dc0485c404e7b6f92eb9499fd0036a07f9e58d3b4a992e8",
							},
						},
					},
					"05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa": {
						RawTX: "02000000013324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c010000006b483045022100bde190f6a794aaaf14b4f1c553724883c8732c6bdcaae8b1633d52df769ffa1f02207f7cfed7183fd8515a575b070297e86a49c548977e456848f3109f342fc754ae412102129cf1690078801a48c1fe3c0bdb6d8aac90756633c9fb7bec40f28403f7a3d9feffffff029eeffa02000000001976a914972e260dd73b41f8d91b1709005b60355cdc36ed88ac00c2eb0b000000001976a914cf3904101bdf618e8f0446bfab91c345111908a088ac6a000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"1c84115865bf49ab2eadf27548cdcb3c36cb8ca5402d77ffa90f1de001a3fee3",
								"98979feadc42e66a67d762f930c22bf12d04ff8224b9d9b859ab29980a27f90a",
							},
						},
					},
				},
			},
		},
		"wrong tx supplied as input in envelope errs": {
			exp:    false,
			expErr: errors.New("proof for different tx supplied"),
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020d9c6bb358e13ec549c3e78ad67b2975f72e164d44f925ccf36fdaf3a35959b0348f38f71db7afaecc2b8b324c44ec05eed43a98de16fcb2e7e501622abff759cb2210161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "e3c66e4eddaa7e7e7560cdd8a80c82126dcbb728b4a3bf48a2be95a7847feacc",
				RawTX: "02000000043324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c000000006b483045022100a1e96789f10de15167385eb1f7505628755aa43750ed0df998066d1b6526a5fe02205883662a7c231509ab233026a9bd7dac1221fcfd22cf92c543ce761588ead52b4121029312d305d805dcbf68a0ffaee417a4852d86ce38708725feff2b1a85db53cc59feffffff0f316367b51170c4c80a4285a3f47712efc4b47b56e736a284aa38bd0e1ec9d4000000006a47304402205d7100dd0bcc901507e84cd94e88da90973fd8381eeec24bdc84e70519604b0c02207bb9eacd817eb04378655a32807f3e76d5ed65cff147fac659db270699b44ef5412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505000000006a4730440220255e048d53f6e3897ea1adebe3ce09259ec8f4814939091a0ff93d754c2f508d02201cbda92db5f25b62363dbf744e6a4b82ec3eb9a9a075d08d8051c9729021d69f4121033e792b95ce7a8c70f68ae6070d5b545957343919fab8b0cb4d6915b6117477d3fefffffffadf675b2205f8382155091cf046ed63a543734f3c5344d92b7c067bd987f505010000006b483045022100ff091628f91fbb9ceda9cd62747e570508f95d14205211288071bd3ae4a4500c0220080dba7b1b9379b21c1bd5fed22f582094b54fdb29c16cfe4de3f709d12975e4412103792d3c6e2bb718a515bc8fa8250d92a548ebe94be39a5676ad5bdcfc5c3dd17ffeffffff029ee8fa02000000001976a9146922fe7841288aa0d71292cb8325c4205e4674d288ac8055c820000000001976a914e4e6936b51ecbe715846556b083747bae09e769088ac6b000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{
							Index:  1,
							TxOrID: "61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd",
							Target: "7264e88cccd8f3cbfc37f3a237b74ed02612c2f381291e3ffc1c70978642afd0",
							Nodes: []string{
								"b1f3ed9a26f39f910a5186f4d33cc5fcef7fdc71328e96f3324e9eb84b54476e",
								"e2a39c08e6cb998a5c7b5e9f4ac9303af43d8e6a859ad8127d9e2c569324f7d2",
								"b17da0617adee7a7dad8147ca03cf5541c33ba10918dd88ddb2bc3889d78db05",
							},
						},
					},
				},
			},
		},
		"wrong merkle proof suppled with otherwise correct input errors": {
			exp:    false,
			expErr: errors.New("input and proof id mismatch"),
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{ // Merkle proof is for a different TX that the current one suppled in input
							Index:  1,
							TxOrID: "05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"1c84115865bf49ab2eadf27548cdcb3c36cb8ca5402d77ffa90f1de001a3fee3",
								"98979feadc42e66a67d762f930c22bf12d04ff8224b9d9b859ab29980a27f90a",
							},
						},
					},
				},
			},
		},
		"wrong merkle proof suppled via hex with otherwise correct input errors": {
			exp:    false,
			expErr: errors.New("input and proof id mismatch"),
			blockHeaderFunc: func(context.Context, string) (*BlockHeader, error) {
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "af554cd922b2acd2f98b74b40c4b9b3c34c67e675226af162538fd6fbc27e3f2",
				RawTX: "0200000002dd5975d42001f949bddbd305a0151f5a02af8c12762c816b4f124590aaecd661010000006b483045022100f0395c6faef111a79863d1beb06576ede11510cc7c4faf2f7d15d676bb9fde6102204f8fbfb3b00c6f1f2feb6ef967f811f820d689d65cb438c848c3202cab929053412103fea85bbd0423b68c678a4d2022d877d9062a1b406945b5c56e4e5c73f88c670ffeffffff4f0ffecd7a155bf39ccf0888ec834ef17f16cb0c42242dca6fde05d694745505000000006b483045022100ffe6c6990edc236c7679b2ac90d075d132230ad7ac54223089e9eeda3c50ff4302205a5a904e9e6c3f5843d4fa6071056ac2d23a525777b827dc825d20b9a8da362b412103659025689fd2d731ef500a4b12482076c8022bc726e98ca87eacc690036f5a60feffffff0200c2eb0b000000001976a91433236d7d53bce84f11875c142753ae9da01a965b88ac9ebdeb0b000000001976a914333d0cc4c776bafc389c867c1956b0ff42b7a4ad88acd3000000",
				Inputs: map[string]*SPVEnvelope{
					"61d6ecaa9045124f6b812c76128caf025a1f15a005d3dbbd49f90120d47559dd": {
						RawTX: "0200000002f5de420f7cfc76a3c3b3739ae1885e0e800bd43ab581e7db20c134d45b9092e4010000006b483045022100fdbdafafec00fee03e567663fc5b63c3d7798df6eafdac1b7d45105c256bbf3e0220110d96657b78ddce4485df4cc59fc782abc5237eaca6fd06f8df25d176e9271d412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff50bfdd732d9b58da2618d3455a3449e1e9f4adbcf738d10a47a7e77340c7f71e000000006b483045022100bfe70637627ec9132050f6c2f76eb0e1dbd2b31833d90e64704856b1993a3dd4022014fc68acf954604ade64ada962084f7dac3c9b573273bc3dec038fdd3bf48910412102eee549cbaf8dd3bd77991845115c20ab8709d215f939d13e2e6ae159c4b4dabffeffffff0200c2eb0b000000001976a9146b627e56d5b1d56dbffccb2f5dddc731bb7e8d6388ac8ac0eb0b000000001976a91419de2a52795e4aacf83f940386dca64ce3c988c288acd2000000",
						Proof: &MerkleProof{ // Merkle proof is for a different TX that the current one suppled in input
							Index:  1,
							TxOrID: "02000000013324273707a2a5da452461d0e4f02b2bec2f87a134fe10cd04a6a8b77978d11c010000006b483045022100bde190f6a794aaaf14b4f1c553724883c8732c6bdcaae8b1633d52df769ffa1f02207f7cfed7183fd8515a575b070297e86a49c548977e456848f3109f342fc754ae412102129cf1690078801a48c1fe3c0bdb6d8aac90756633c9fb7bec40f28403f7a3d9feffffff029eeffa02000000001976a914972e260dd73b41f8d91b1709005b60355cdc36ed88ac00c2eb0b000000001976a914cf3904101bdf618e8f0446bfab91c345111908a088ac6a000000",
							Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
							Nodes: []string{
								"1c84115865bf49ab2eadf27548cdcb3c36cb8ca5402d77ffa90f1de001a3fee3",
								"98979feadc42e66a67d762f930c22bf12d04ff8224b9d9b859ab29980a27f90a",
							},
						},
					},
				},
			},
		},
		"valid multiple layer tx passes": {
			exp: true,
			blockHeaderFunc: func(ctx context.Context, blockHash string) (*BlockHeader, error) {
				switch blockHash {
				case "4980969d0fa17a8bfb541c54cf715cfb07b5c1bd6c272a5ba739810aa786dbc2": //nolint:goconst
					return EncodeBlockHeaderStr("000000206e687283a5fb7b5e3a1e8e3452e431f8f987c9624b709d0bb65222adde722a6b219d5619fe8b4fc9dc056c81b28eedbd38be9f5e9b2e51def60106e836da8cf9164e0161ffff7f2000000000")
				case "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e": //nolint:goconst
					return EncodeBlockHeaderStr("00000020b575b47d65d7ef45b33facecef8b24b46ed1f2900413f0396fbc4dc8fc3e517f35ab994946ff6b342e24ff55b08a2f36b167dca104c49d9103b8d2bb83e991d3c44d0161ffff7f2001000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "16519695ea4c79b80953192f1ff4d0b828cd19d529f27c1fe45a4b1585e437b0",
				RawTX: "020000000204b160d59dac43bec838f8d9a93b8adf28f14d9798b1baaf90f11c7f1a7cc0c9010000006a47304402201e7e779f65f887c48650680c6d60b3a4565d51b011b9f3cccdbbe36bf8c31752022055957ede7c8b4cf0505ab4f250eca85ea9214ac2ec3c7dd5df3808f3225c8ce54121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff108e6958fed7d9ab449cd2285b7362ef025901a7fd370bbb1d1a56fc6d11d0e8000000006a47304402202fc570aafaf6c8b606a92eaf51d018da9ac6c739bd5db6be43e47a5b82b4a9b202205804176d19f68005c990ec188bae6f7864041ba5c6d1b505e4caaf46dc97c039412103f9faef2f65cba8df4003d91d8bf16a1d7fc82e77813360e6681f6d663f2c92b1feffffff0200ca9a3b000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac8ac0eb0b000000001976a914714ea9cfc710275d3eba4b5a116a724299057f8888acd0000000",
				Inputs: map[string]*SPVEnvelope{
					"e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10": {
						TxID:  "e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10",
						RawTX: "02000000022cbec1e99aacccedccfd6274d8d741a22d7fd1e5d65b58af890e4dc7d0b5aef9000000006b483045022100c14c4c7909c9fbcc8597767637daf4acfa7a7e43f0bcb57a82a9cfe07f0d169e02206243c62953c835b1a00c843cf94fb9a869b67b811b4c99a1900ac2c55b21eac14121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffffc710a11837d8208a51e4b8a1ddc3aa5077fb8172e63ea44a0040284ee201c6f3000000006a47304402203bd3b3dc3a7b17dcd32d7cbc86a83700fa3d9bd9194f39b7255bba6a1f01bce702204fd594eeab7012cb285a116b3f2cd22a0ff3c907f19465273867662c7a3902b74121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff020027b929000000001976a91433cf3e04fc0b3264ce19d9b09b046a0b11617b8188ac8aa1e111000000001976a91466d296cbdba31a0cd733c3778dd059428fe7f01788accc000000",
						Inputs: map[string]*SPVEnvelope{
							"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c": {
								RawTX: "0200000001a45612a9c98030fdc5e350029ff13fb9a4bf4207819bf0ffc9c8e8595751576d0000000049483045022100f600fcaa08f7c7c0494385a821fb42196b1487a5ff882242224d3bc4dd02f72c0220418e145c571d881bf977a5af14db259414df259dced1eb8663362c504851558b41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914b26aac659ec4703fb1d7fce3e56eb98743c1483288accb000000",
								Proof: &MerkleProof{
									Index:  4,
									TxOrID: "f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
							"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7": {
								RawTX: "020000000121d1cbda5439d99b053abe2a4f81d34ddd5349cb2fb46b537f99348a018c040a00000000494830450221008c28f5443fe1daced51465ad3665af74c8bbec7334a1500da02859e4f61a4d0702203a73bc0ebb45c4799008ef9b666e01907fca1e2eb12eda528c7cf2dddc148c0f41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914bbbc06d2cb49f48f0338239d354e023ad9eedb7588accb000000",
								Proof: &MerkleProof{
									Index:  5,
									TxOrID: "f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
						},
					},
					"c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104": {
						TxID:  "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
						RawTX: "0200000001d5653309f34addbe017b7f36f95bab4375c8f759c7323eafadd9827c4a60493d0000000048473044022067f66a7cdda8b6e3395095c99d8883c6e79f1ce2c9f19ddde0fb8acc3186531902204f6c9dd6184543a40ba8b9360fa74eac0961cfcc36564c8b2667c7a39e01ffc941feffffff02408c380c010000001976a914c01024d5ccfa50cd24431facc859f1904930a6ab88ac0065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988accb000000",
						Proof: &MerkleProof{
							Index:  2,
							TxOrID: "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
							Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
							Nodes: []string{
								"1849a6749e9ea4afbaa7bf3dd7323f38830e8351f58864e2991ee3e6af27d8a3",
								"cd89244cbe9f6b94d260747b2546f4a80d2b007ca9a17c06d61a84df28127e4e",
								"4d43e5fd615782958402e8b231171ee03eebeccb37817f13d380295cc958abee",
							},
						},
					},
				},
			},
		},
		"invalid multiple layer tx false": {
			exp: false,
			blockHeaderFunc: func(ctx context.Context, blockHash string) (*BlockHeader, error) {
				switch blockHash {
				case "4980969d0fa17a8bfb541c54cf715cfb07b5c1bd6c272a5ba739810aa786dbc2":
					return EncodeBlockHeaderStr("000000206e687283a5fb7b5e3a1e8e3452e431f8f987c9624b709d0bb65222adde722a6b219d5619fe8b4fc9dc056c81b28eedbd38be9f5e9b2e51def60106e836da8cf9164e0161ffff7f2000000000")
				case "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e":
					return EncodeBlockHeaderStr("00000020b575b47d65d7ef45b33facecef8b24b46ed1f2900413f0396fbc4dc8fc3e517f35ab994946ff6b342e24ff55b08a2f36b167dca104c49d9103b8d2bb83e991d3c44d0161ffff7f2001000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "16519695ea4c79b80953192f1ff4d0b828cd19d529f27c1fe45a4b1585e437b0",
				RawTX: "020000000204b160d59dac43bec838f8d9a93b8adf28f14d9798b1baaf90f11c7f1a7cc0c9010000006a47304402201e7e779f65f887c48650680c6d60b3a4565d51b011b9f3cccdbbe36bf8c31752022055957ede7c8b4cf0505ab4f250eca85ea9214ac2ec3c7dd5df3808f3225c8ce54121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff108e6958fed7d9ab449cd2285b7362ef025901a7fd370bbb1d1a56fc6d11d0e8000000006a47304402202fc570aafaf6c8b606a92eaf51d018da9ac6c739bd5db6be43e47a5b82b4a9b202205804176d19f68005c990ec188bae6f7864041ba5c6d1b505e4caaf46dc97c039412103f9faef2f65cba8df4003d91d8bf16a1d7fc82e77813360e6681f6d663f2c92b1feffffff0200ca9a3b000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac8ac0eb0b000000001976a914714ea9cfc710275d3eba4b5a116a724299057f8888acd0000000",
				Inputs: map[string]*SPVEnvelope{
					"e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10": {
						TxID:  "e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10",
						RawTX: "02000000022cbec1e99aacccedccfd6274d8d741a22d7fd1e5d65b58af890e4dc7d0b5aef9000000006b483045022100c14c4c7909c9fbcc8597767637daf4acfa7a7e43f0bcb57a82a9cfe07f0d169e02206243c62953c835b1a00c843cf94fb9a869b67b811b4c99a1900ac2c55b21eac14121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffffc710a11837d8208a51e4b8a1ddc3aa5077fb8172e63ea44a0040284ee201c6f3000000006a47304402203bd3b3dc3a7b17dcd32d7cbc86a83700fa3d9bd9194f39b7255bba6a1f01bce702204fd594eeab7012cb285a116b3f2cd22a0ff3c907f19465273867662c7a3902b74121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff020027b929000000001976a91433cf3e04fc0b3264ce19d9b09b046a0b11617b8188ac8aa1e111000000001976a91466d296cbdba31a0cd733c3778dd059428fe7f01788accc000000",
						Inputs: map[string]*SPVEnvelope{
							"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c": {
								RawTX: "0200000001a45612a9c98030fdc5e350029ff13fb9a4bf4207819bf0ffc9c8e8595751576d0000000049483045022100f600fcaa08f7c7c0494385a821fb42196b1487a5ff882242224d3bc4dd02f72c0220418e145c571d881bf977a5af14db259414df259dced1eb8663362c504851558b41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914b26aac659ec4703fb1d7fce3e56eb98743c1483288accb000000",
								Proof: &MerkleProof{
									Index:  4,
									TxOrID: "f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
							"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7": {
								RawTX: "020000000121d1cbda5439d99b053abe2a4f81d34ddd5349cb2fb46b537f99348a018c040a00000000494830450221008c28f5443fe1daced51465ad3665af74c8bbec7334a1500da02859e4f61a4d0702203a73bc0ebb45c4799008ef9b666e01907fca1e2eb12eda528c7cf2dddc148c0f41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914bbbc06d2cb49f48f0338239d354e023ad9eedb7588accb000000",
								Proof: &MerkleProof{
									Index:  1, // invalid index, should be 5
									TxOrID: "f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
						},
					},
					"c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104": {
						TxID:  "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
						RawTX: "0200000001d5653309f34addbe017b7f36f95bab4375c8f759c7323eafadd9827c4a60493d0000000048473044022067f66a7cdda8b6e3395095c99d8883c6e79f1ce2c9f19ddde0fb8acc3186531902204f6c9dd6184543a40ba8b9360fa74eac0961cfcc36564c8b2667c7a39e01ffc941feffffff02408c380c010000001976a914c01024d5ccfa50cd24431facc859f1904930a6ab88ac0065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988accb000000",
						Proof: &MerkleProof{
							Index:  2,
							TxOrID: "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
							Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
							Nodes: []string{
								"1849a6749e9ea4afbaa7bf3dd7323f38830e8351f58864e2991ee3e6af27d8a3",
								"cd89244cbe9f6b94d260747b2546f4a80d2b007ca9a17c06d61a84df28127e4e",
								"4d43e5fd615782958402e8b231171ee03eebeccb37817f13d380295cc958abee",
							},
						},
					},
				},
			},
		},
		"wrong merkle proof suppled with otherwise correct layered input errors": {
			exp:    false,
			expErr: errors.New("input and proof id mismatch"),
			blockHeaderFunc: func(ctx context.Context, blockHash string) (*BlockHeader, error) {
				switch blockHash {
				case "4980969d0fa17a8bfb541c54cf715cfb07b5c1bd6c272a5ba739810aa786dbc2":
					return EncodeBlockHeaderStr("000000206e687283a5fb7b5e3a1e8e3452e431f8f987c9624b709d0bb65222adde722a6b219d5619fe8b4fc9dc056c81b28eedbd38be9f5e9b2e51def60106e836da8cf9164e0161ffff7f2000000000")
				case "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e":
					return EncodeBlockHeaderStr("00000020b575b47d65d7ef45b33facecef8b24b46ed1f2900413f0396fbc4dc8fc3e517f35ab994946ff6b342e24ff55b08a2f36b167dca104c49d9103b8d2bb83e991d3c44d0161ffff7f2001000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "16519695ea4c79b80953192f1ff4d0b828cd19d529f27c1fe45a4b1585e437b0",
				RawTX: "020000000204b160d59dac43bec838f8d9a93b8adf28f14d9798b1baaf90f11c7f1a7cc0c9010000006a47304402201e7e779f65f887c48650680c6d60b3a4565d51b011b9f3cccdbbe36bf8c31752022055957ede7c8b4cf0505ab4f250eca85ea9214ac2ec3c7dd5df3808f3225c8ce54121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff108e6958fed7d9ab449cd2285b7362ef025901a7fd370bbb1d1a56fc6d11d0e8000000006a47304402202fc570aafaf6c8b606a92eaf51d018da9ac6c739bd5db6be43e47a5b82b4a9b202205804176d19f68005c990ec188bae6f7864041ba5c6d1b505e4caaf46dc97c039412103f9faef2f65cba8df4003d91d8bf16a1d7fc82e77813360e6681f6d663f2c92b1feffffff0200ca9a3b000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac8ac0eb0b000000001976a914714ea9cfc710275d3eba4b5a116a724299057f8888acd0000000",
				Inputs: map[string]*SPVEnvelope{
					"e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10": {
						TxID:  "e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10",
						RawTX: "02000000022cbec1e99aacccedccfd6274d8d741a22d7fd1e5d65b58af890e4dc7d0b5aef9000000006b483045022100c14c4c7909c9fbcc8597767637daf4acfa7a7e43f0bcb57a82a9cfe07f0d169e02206243c62953c835b1a00c843cf94fb9a869b67b811b4c99a1900ac2c55b21eac14121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffffc710a11837d8208a51e4b8a1ddc3aa5077fb8172e63ea44a0040284ee201c6f3000000006a47304402203bd3b3dc3a7b17dcd32d7cbc86a83700fa3d9bd9194f39b7255bba6a1f01bce702204fd594eeab7012cb285a116b3f2cd22a0ff3c907f19465273867662c7a3902b74121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff020027b929000000001976a91433cf3e04fc0b3264ce19d9b09b046a0b11617b8188ac8aa1e111000000001976a91466d296cbdba31a0cd733c3778dd059428fe7f01788accc000000",
						Inputs: map[string]*SPVEnvelope{
							"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c": {
								RawTX: "0200000001a45612a9c98030fdc5e350029ff13fb9a4bf4207819bf0ffc9c8e8595751576d0000000049483045022100f600fcaa08f7c7c0494385a821fb42196b1487a5ff882242224d3bc4dd02f72c0220418e145c571d881bf977a5af14db259414df259dced1eb8663362c504851558b41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914b26aac659ec4703fb1d7fce3e56eb98743c1483288accb000000",
								Proof: &MerkleProof{
									Index:  4,
									TxOrID: "f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
							"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7": {
								RawTX: "020000000121d1cbda5439d99b053abe2a4f81d34ddd5349cb2fb46b537f99348a018c040a00000000494830450221008c28f5443fe1daced51465ad3665af74c8bbec7334a1500da02859e4f61a4d0702203a73bc0ebb45c4799008ef9b666e01907fca1e2eb12eda528c7cf2dddc148c0f41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914bbbc06d2cb49f48f0338239d354e023ad9eedb7588accb000000",
								Proof: &MerkleProof{ // Merkle proof is for a different TX that the current one suppled in input
									Index:  1,
									TxOrID: "05f587d97b067c2bd944533c4f7343a563ed46f01c09552138f805225b67dffa",
									Target: "73894de091bb6910882295dc9d03539aae560de3612552285d612faa0fc3c216",
									Nodes: []string{
										"1c84115865bf49ab2eadf27548cdcb3c36cb8ca5402d77ffa90f1de001a3fee3",
										"98979feadc42e66a67d762f930c22bf12d04ff8224b9d9b859ab29980a27f90a",
									},
								},
							},
						},
					},
					"c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104": {
						TxID:  "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
						RawTX: "0200000001d5653309f34addbe017b7f36f95bab4375c8f759c7323eafadd9827c4a60493d0000000048473044022067f66a7cdda8b6e3395095c99d8883c6e79f1ce2c9f19ddde0fb8acc3186531902204f6c9dd6184543a40ba8b9360fa74eac0961cfcc36564c8b2667c7a39e01ffc941feffffff02408c380c010000001976a914c01024d5ccfa50cd24431facc859f1904930a6ab88ac0065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988accb000000",
						Proof: &MerkleProof{
							Index:  2,
							TxOrID: "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
							Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
							Nodes: []string{
								"1849a6749e9ea4afbaa7bf3dd7323f38830e8351f58864e2991ee3e6af27d8a3",
								"cd89244cbe9f6b94d260747b2546f4a80d2b007ca9a17c06d61a84df28127e4e",
								"4d43e5fd615782958402e8b231171ee03eebeccb37817f13d380295cc958abee",
							},
						},
					},
				},
			},
		},
		"single missing merkle proof in layered and branching tx errors": {
			exp:    false,
			expErr: errors.New("no confirmed transaction provided"),
			blockHeaderFunc: func(ctx context.Context, blockHash string) (*BlockHeader, error) {
				switch blockHash {
				case "4980969d0fa17a8bfb541c54cf715cfb07b5c1bd6c272a5ba739810aa786dbc2":
					return EncodeBlockHeaderStr("000000206e687283a5fb7b5e3a1e8e3452e431f8f987c9624b709d0bb65222adde722a6b219d5619fe8b4fc9dc056c81b28eedbd38be9f5e9b2e51def60106e836da8cf9164e0161ffff7f2000000000")
				case "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e":
					return EncodeBlockHeaderStr("00000020b575b47d65d7ef45b33facecef8b24b46ed1f2900413f0396fbc4dc8fc3e517f35ab994946ff6b342e24ff55b08a2f36b167dca104c49d9103b8d2bb83e991d3c44d0161ffff7f2001000000")
				}
				return EncodeBlockHeaderStr("00000020de9b608240602bc7d4fd84db40828435cf29939f63d7acdaf080490992ca244dc13856f79f45f57721d007a2bb93d165625dc944b629bd231c1de5437ff7e5786e320161ffff7f2000000000")
			},
			envelope: &SPVEnvelope{
				TxID:  "16519695ea4c79b80953192f1ff4d0b828cd19d529f27c1fe45a4b1585e437b0",
				RawTX: "020000000204b160d59dac43bec838f8d9a93b8adf28f14d9798b1baaf90f11c7f1a7cc0c9010000006a47304402201e7e779f65f887c48650680c6d60b3a4565d51b011b9f3cccdbbe36bf8c31752022055957ede7c8b4cf0505ab4f250eca85ea9214ac2ec3c7dd5df3808f3225c8ce54121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff108e6958fed7d9ab449cd2285b7362ef025901a7fd370bbb1d1a56fc6d11d0e8000000006a47304402202fc570aafaf6c8b606a92eaf51d018da9ac6c739bd5db6be43e47a5b82b4a9b202205804176d19f68005c990ec188bae6f7864041ba5c6d1b505e4caaf46dc97c039412103f9faef2f65cba8df4003d91d8bf16a1d7fc82e77813360e6681f6d663f2c92b1feffffff0200ca9a3b000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac8ac0eb0b000000001976a914714ea9cfc710275d3eba4b5a116a724299057f8888acd0000000",
				Inputs: map[string]*SPVEnvelope{
					"e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10": {
						TxID:  "e8d0116dfc561a1dbb0b37fda7015902ef62735b28d29c44abd9d7fe58698e10",
						RawTX: "02000000022cbec1e99aacccedccfd6274d8d741a22d7fd1e5d65b58af890e4dc7d0b5aef9000000006b483045022100c14c4c7909c9fbcc8597767637daf4acfa7a7e43f0bcb57a82a9cfe07f0d169e02206243c62953c835b1a00c843cf94fb9a869b67b811b4c99a1900ac2c55b21eac14121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffffc710a11837d8208a51e4b8a1ddc3aa5077fb8172e63ea44a0040284ee201c6f3000000006a47304402203bd3b3dc3a7b17dcd32d7cbc86a83700fa3d9bd9194f39b7255bba6a1f01bce702204fd594eeab7012cb285a116b3f2cd22a0ff3c907f19465273867662c7a3902b74121028300e674b820a0f0df1c3399e9ef26dbca6ca1fdd9a4c53e5dbc964dcc6f2111feffffff020027b929000000001976a91433cf3e04fc0b3264ce19d9b09b046a0b11617b8188ac8aa1e111000000001976a91466d296cbdba31a0cd733c3778dd059428fe7f01788accc000000",
						Inputs: map[string]*SPVEnvelope{
							"f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c": {
								RawTX: "0200000001a45612a9c98030fdc5e350029ff13fb9a4bf4207819bf0ffc9c8e8595751576d0000000049483045022100f600fcaa08f7c7c0494385a821fb42196b1487a5ff882242224d3bc4dd02f72c0220418e145c571d881bf977a5af14db259414df259dced1eb8663362c504851558b41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914b26aac659ec4703fb1d7fce3e56eb98743c1483288accb000000",
								Proof: &MerkleProof{
									Index:  4,
									TxOrID: "f9aeb5d0c74d0e89af585bd6e5d17f2da241d7d87462fdccedccac9ae9c1be2c",
									Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
									Nodes: []string{
										"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7",
										"*",
										"09ca16b38bfdcacec20ad2662a5fa8ad81a7599b35c54f898056841cd3428891",
									},
								},
							},
							"f3c601e24e2840004aa43ee67281fb7750aac3dda1b8e4518a20d83718a110c7": {
								RawTX: "020000000121d1cbda5439d99b053abe2a4f81d34ddd5349cb2fb46b537f99348a018c040a00000000494830450221008c28f5443fe1daced51465ad3665af74c8bbec7334a1500da02859e4f61a4d0702203a73bc0ebb45c4799008ef9b666e01907fca1e2eb12eda528c7cf2dddc148c0f41feffffff020065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988ac408c380c010000001976a914bbbc06d2cb49f48f0338239d354e023ad9eedb7588accb000000",
							},
						},
					},
					"c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104": {
						TxID:  "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
						RawTX: "0200000001d5653309f34addbe017b7f36f95bab4375c8f759c7323eafadd9827c4a60493d0000000048473044022067f66a7cdda8b6e3395095c99d8883c6e79f1ce2c9f19ddde0fb8acc3186531902204f6c9dd6184543a40ba8b9360fa74eac0961cfcc36564c8b2667c7a39e01ffc941feffffff02408c380c010000001976a914c01024d5ccfa50cd24431facc859f1904930a6ab88ac0065cd1d000000001976a9146e8f17ecfc40ef5b429d22c86ffe8acb2acc886988accb000000",
						Proof: &MerkleProof{
							Index:  2,
							TxOrID: "c9c07c1a7f1cf190afbab198974df128df8a3ba9d9f838c8be43ac9dd560b104",
							Target: "6b2a72dead2252b60b9d704b62c987f9f831e452348e1e3a5e7bfba58372686e",
							Nodes: []string{
								"1849a6749e9ea4afbaa7bf3dd7323f38830e8351f58864e2991ee3e6af27d8a3",
								"cd89244cbe9f6b94d260747b2546f4a80d2b007ca9a17c06d61a84df28127e4e",
								"4d43e5fd615782958402e8b231171ee03eebeccb37817f13d380295cc958abee",
							},
						},
					},
				},
			},
		},
	}

	for name, test := range tests {
		t.Run(name, func(t *testing.T) {
			s, err := NewSPVClient(WithBlockHeaderChain(&mockBlockHeaderClient{
				blockHeaderFunc: test.blockHeaderFunc,
			}))
			assert.NoError(t, err, "expected no error when creating spv client")

			valid, err := s.VerifyPayment(context.Background(), test.envelope)
			if test.expErr != nil {
				assert.Error(t, err)
				assert.EqualError(t, err, test.expErr.Error())
			} else {
				assert.NoError(t, err)
			}
			assert.Equal(t, test.exp, valid)
		})
	}
}
